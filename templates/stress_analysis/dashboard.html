{% extends "basic.html" %}
{% load static %}

{% block head %}
<style>
    .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .connected {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .disconnected {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .data-status {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <!-- Connection Status -->
    <div class="connection-status {% if google_fit_connected %}connected{% else %}disconnected{% endif %}">
        <strong>Google Fit Status:</strong> 
        {% if google_fit_connected %}
            ✅ Connected - You can now sync your health data
        {% else %}
            ❌ Not Connected - Connect to view your real health data
        {% endif %}
    </div>

    <!-- Data Availability Status -->
    {% if google_fit_connected and not data_available %}
    <div class="data-status">
        ℹ️ Connected but no health data found. Make sure you have:
        <ul class="mb-0 mt-2">
            <li>Google Fit app installed on your phone</li>
            <li>Heart rate, sleep, or step data in Google Fit</li>
            <li>Data synced to your Google account</li>
        </ul>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="row">
        <div class="col-md-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Stress Analysis Dashboard</h1>
                <div>
                    {% if not google_fit_connected %}
                        <a href="{% url 'stress_analysis:connect_google_fit' %}" class="btn btn-success">
                            Connect Google Fit
                        </a>
                    {% else %}
                        <button class="btn btn-primary me-2" onclick="syncData()" id="syncButton">
                            Sync Data
                        </button>
                        <a href="{% url 'stress_analysis:disconnect_google_fit' %}" class="btn btn-outline-danger">
                            Disconnect
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Data Source Info -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Data Source:</strong> 
                            <span id="dataSource" class="badge bg-info">Loading...</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Last Sync:</strong> 
                            <span id="lastSync">Never</span>
                        </div>
                        <div class="col-md-4">
                            <strong>Analysis Period:</strong> 
                            <span id="analysisPeriod">Last 7 days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statisticsCards" style="display: none;">
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-primary" id="avgStress">--</div>
                <div class="stat-label">Avg Stress Level</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-success" id="avgHeartRate">--</div>
                <div class="stat-label">Avg Heart Rate</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-info" id="avgSleep">--</div>
                <div class="stat-label">Avg Sleep (hrs)</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-warning" id="avgSteps">--</div>
                <div class="stat-label">Avg Steps</div>
            </div>
        </div>
    </div>

    <!-- Main Stress Chart -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Stress Level Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="stressChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Metrics Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Heart Rate Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="heartRateChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Sleep Pattern Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="sleepChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Metrics Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Activity Analysis (Steps)</h5>
                </div>
                <div class="card-body">
                    <canvas id="stepsChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Calories Burned</h5>
                </div>
                <div class="card-body">
                    <canvas id="caloriesChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Correlation Analysis -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Correlation Analysis</h5>
                </div>
                <div class="card-body">
                    <canvas id="correlationChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Stress Pattern Analysis -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Stress Pattern Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="patternChart" height="120"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div id="patternInsights">
                                <h6>Pattern Insights:</h6>
                                <div id="insightsContent" class="mt-3">
                                    <p class="text-muted">Analyzing your stress patterns...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recommendations Section -->
    <div class="row mb-4" id="recommendationsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Personalized Recommendations</h5>
                </div>
                <div class="card-body">
                    <div id="recommendationsContent">
                        <p class="text-muted">Loading recommendations based on your data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {% if not google_fit_connected %}
                    <a href="{% url 'stress_analysis:connect_google_fit' %}" class="btn btn-success btn-block mb-2">
                        Connect Google Fit
                    </a>
                    {% else %}
                    <button class="btn btn-primary btn-block mb-2" onclick="syncData()">
                        Sync Data Now
                    </button>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info btn-block mb-2" onclick="loadData()">
                        Refresh Charts
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning btn-block mb-2" onclick="generateReport()">
                        Generate Report
                    </button>
                </div>
                <div class="col-md-3">
                    <a href="/" class="btn btn-outline-secondary btn-block mb-2">
                        Back to Main App
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let stressChart = null;
    let heartRateChart = null;
    let sleepChart = null;
    let stepsChart = null;
    let caloriesChart = null;
    let correlationChart = null;
    let patternChart = null;

    function loadData() {
        fetch('/stress-analysis/api/insights/')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    renderAllCharts(data);
                    updateStatistics(data);
                    updateDataStatus(data);
                    generateInsights(data);
                    generateRecommendations(data);
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                alert('Error loading data: ' + error);
            });
    }

    function updateStatistics(data) {
        if (data.statistics) {
            document.getElementById('avgStress').textContent = data.statistics.average_stress;
            document.getElementById('avgHeartRate').textContent = Math.round(data.heart_rates.reduce((a, b) => a + b, 0) / data.heart_rates.length);
            document.getElementById('avgSleep').textContent = (data.sleep_durations.reduce((a, b) => a + b, 0) / data.sleep_durations.length).toFixed(1);
            document.getElementById('avgSteps').textContent = Math.round(data.steps_data.reduce((a, b) => a + b, 0) / data.steps_data.length).toLocaleString();
            document.getElementById('statisticsCards').style.display = 'block';
        }
    }

    function updateDataStatus(data) {
        document.getElementById('dataSource').textContent = data.data_source;
        document.getElementById('dataSource').className = data.has_real_data ? 'badge bg-success' : 'badge bg-warning';
        
        if (data.has_real_data) {
            document.getElementById('lastSync').textContent = new Date().toLocaleString();
        }
    }

    function renderAllCharts(data) {
        renderStressChart(data);
        renderHeartRateChart(data);
        renderSleepChart(data);
        renderStepsChart(data);
        renderCaloriesChart(data);
        renderCorrelationChart(data);
        renderPatternChart(data);
    }

    function renderStressChart(data) {
        const ctx = document.getElementById('stressChart').getContext('2d');
        
        if (stressChart) stressChart.destroy();

        stressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Stress Level',
                    data: data.stress_levels,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Stress Level Trend' },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: 25,
                                yMax: 25,
                                borderColor: 'green',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Low Stress',
                                    enabled: true
                                }
                            },
                            line2: {
                                type: 'line',
                                yMin: 50,
                                yMax: 50,
                                borderColor: 'orange',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'Moderate Stress',
                                    enabled: true
                                }
                            },
                            line3: {
                                type: 'line',
                                yMin: 75,
                                yMax: 75,
                                borderColor: 'red',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    content: 'High Stress',
                                    enabled: true
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Stress Level' }
                    }
                }
            }
        });
    }

    function renderHeartRateChart(data) {
        const ctx = document.getElementById('heartRateChart').getContext('2d');
        
        if (heartRateChart) heartRateChart.destroy();

        heartRateChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Heart Rate (BPM)',
                    data: data.heart_rates,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Heart Rate Trend' }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'BPM' }
                    }
                }
            }
        });
    }

    function renderSleepChart(data) {
        const ctx = document.getElementById('sleepChart').getContext('2d');
        
        if (sleepChart) sleepChart.destroy();

        sleepChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Sleep Duration (hours)',
                    data: data.sleep_durations,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Sleep Duration Analysis' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Hours' }
                    }
                }
            }
        });
    }

    function renderStepsChart(data) {
        const ctx = document.getElementById('stepsChart').getContext('2d');
        
        if (stepsChart) stepsChart.destroy();

        stepsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Steps',
                    data: data.steps_data,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Daily Step Count' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Steps' }
                    }
                }
            }
        });
    }

    function renderCaloriesChart(data) {
        const ctx = document.getElementById('caloriesChart').getContext('2d');
        
        if (caloriesChart) caloriesChart.destroy();

        // For demo - generate calories data if not available
        const caloriesData = data.calories_data || data.steps_data.map(steps => steps * 0.04);

        caloriesChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Calories Burned',
                    data: caloriesData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Calories Burned Trend' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Calories' }
                    }
                }
            }
        });
    }

    function renderCorrelationChart(data) {
        const ctx = document.getElementById('correlationChart').getContext('2d');
        
        if (correlationChart) correlationChart.destroy();

        // Calculate correlations (simplified)
        const stressVsSleep = calculateCorrelation(data.stress_levels, data.sleep_durations);
        const stressVsActivity = calculateCorrelation(data.stress_levels, data.steps_data);
        const stressVsHeartRate = calculateCorrelation(data.stress_levels, data.heart_rates);

        correlationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Stress vs Sleep', 'Stress vs Activity', 'Stress vs Heart Rate'],
                datasets: [{
                    label: 'Correlation Coefficient',
                    data: [stressVsSleep, stressVsActivity, stressVsHeartRate],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(255, 99, 132, 0.6)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Stress Correlation Analysis' }
                },
                scales: {
                    y: {
                        min: -1,
                        max: 1,
                        title: { display: true, text: 'Correlation' }
                    }
                }
            }
        });
    }

    function renderPatternChart(data) {
        const ctx = document.getElementById('patternChart').getContext('2d');
        
        if (patternChart) patternChart.destroy();

        // Categorize stress levels
        const stressCategories = data.stress_levels.map(level => {
            if (level < 25) return 'Low';
            if (level < 50) return 'Moderate';
            if (level < 75) return 'High';
            return 'Very High';
        });

        const categoryCounts = {
            'Low': stressCategories.filter(c => c === 'Low').length,
            'Moderate': stressCategories.filter(c => c === 'Moderate').length,
            'High': stressCategories.filter(c => c === 'High').length,
            'Very High': stressCategories.filter(c => c === 'Very High').length
        };

        patternChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(categoryCounts),
                datasets: [{
                    data: Object.values(categoryCounts),
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(255, 99, 132, 0.6)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: { display: true, text: 'Stress Level Distribution' }
                }
            }
        });
    }

    function calculateCorrelation(array1, array2) {
        // Simple correlation calculation
        const n = array1.length;
        const sum1 = array1.reduce((a, b) => a + b, 0);
        const sum2 = array2.reduce((a, b) => a + b, 0);
        const sum1Sq = array1.reduce((a, b) => a + b * b, 0);
        const sum2Sq = array2.reduce((a, b) => a + b * b, 0);
        const pSum = array1.reduce((a, b, i) => a + b * array2[i], 0);
        
        const num = pSum - (sum1 * sum2 / n);
        const den = Math.sqrt((sum1Sq - sum1 * sum1 / n) * (sum2Sq - sum2 * sum2 / n));
        
        return den === 0 ? 0 : num / den;
    }

    function generateInsights(data) {
        const insightsContent = document.getElementById('insightsContent');
        const avgStress = data.statistics.average_stress;
        const maxStress = data.statistics.max_stress;
        
        let insights = [];
        
        if (avgStress < 25) {
            insights.push('Your stress levels are generally low and healthy.');
        } else if (avgStress < 50) {
            insights.push('You have moderate stress levels. Consider incorporating relaxation techniques.');
        } else if (avgStress < 75) {
            insights.push('Your stress levels are high. Regular exercise and proper sleep can help.');
        } else {
            insights.push('You have very high stress levels. Consider consulting a healthcare professional.');
        }
        
        // Sleep insights
        const avgSleep = data.sleep_durations.reduce((a, b) => a + b, 0) / data.sleep_durations.length;
        if (avgSleep < 6) {
            insights.push('Your average sleep duration is below recommended levels (7-9 hours).');
        } else if (avgSleep > 9) {
            insights.push('You\'re getting adequate sleep, which helps manage stress.');
        }
        
        // Activity insights
        const avgSteps = data.steps_data.reduce((a, b) => a + b, 0) / data.steps_data.length;
        if (avgSteps < 5000) {
            insights.push('Consider increasing your daily activity to help reduce stress.');
        }
        
        insightsContent.innerHTML = insights.map(insight => 
            `<div class="alert alert-info mb-2">${insight}</div>`
        ).join('');
    }

    function generateRecommendations(data) {
        const recommendationsContent = document.getElementById('recommendationsContent');
        document.getElementById('recommendationsSection').style.display = 'block';
        
        const avgStress = data.statistics.average_stress;
        const avgSleep = data.sleep_durations.reduce((a, b) => a + b, 0) / data.sleep_durations.length;
        const avgSteps = data.steps_data.reduce((a, b) => a + b, 0) / data.steps_data.length;
        
        let recommendations = [];
        
        if (avgStress > 50) {
            recommendations.push({
                title: 'Practice Deep Breathing',
                description: '5-10 minutes of deep breathing exercises daily',
                priority: 'high'
            });
        }
        
        if (avgSleep < 7) {
            recommendations.push({
                title: 'Improve Sleep Routine',
                description: 'Aim for 7-9 hours of quality sleep with consistent bedtime',
                priority: 'high'
            });
        }
        
        if (avgSteps < 7000) {
            recommendations.push({
                title: 'Increase Physical Activity',
                description: 'Take a 30-minute walk daily to reduce stress',
                priority: 'medium'
            });
        }
        
        recommendations.push({
            title: 'Stay Hydrated',
            description: 'Drink at least 8 glasses of water throughout the day',
            priority: 'low'
        });
        
        recommendationsContent.innerHTML = recommendations.map(rec => 
            `<div class="alert ${rec.priority === 'high' ? 'alert-danger' : rec.priority === 'medium' ? 'alert-warning' : 'alert-info'} mb-2">
                <strong>${rec.title}</strong><br>
                ${rec.description}
            </div>`
        ).join('');
    }

    function generateReport() {
        alert('Report generation feature will be implemented soon!');
        // This could generate a PDF or detailed analysis report
    }

    function syncData() {
        const syncButton = document.getElementById('syncButton');
        const originalText = syncButton.textContent;
        
        syncButton.disabled = true;
        syncButton.textContent = 'Syncing...';
        
        fetch('/stress-analysis/sync-data/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ ' + data.message);
                loadData(); // Reload all data and charts
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ Sync failed: ' + error);
        })
        .finally(() => {
            syncButton.disabled = false;
            syncButton.textContent = originalText;
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadData();
    });
</script>
{% endblock %}