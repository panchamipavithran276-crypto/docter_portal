{% extends "basic.html" %}
{% load static %}

{% block head %}
<style>
    .connection-status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
    .connected {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .disconnected {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .data-collection-guide {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 25px;
        text-align: center;
        margin-bottom: 20px;
    }
    .data-requirements {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 25px 0;
    }
    .requirement-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }
    .req-icon {
        font-size: 2em;
        margin-bottom: 10px;
    }
    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .status-badge.available { background: #d4edda; color: #155724; }
    .status-badge.partial { background: #fff3cd; color: #856404; }
    .status-badge.missing { background: #f8d7da; color: #721c24; }
    .btn-fix, .btn-refresh {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn-fix:hover, .btn-refresh:hover {
        background: #0056b3;
    }
    .action-list {
        text-align: left;
        margin: 20px 0;
    }
    .action-list li {
        margin: 8px 0;
        padding-left: 10px;
    }
    .stat-card {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
    }
    .stat-label {
        font-size: 14px;
        color: #6c757d;
    }
    .data-source-badge {
        font-size: 0.7em;
        margin-left: 5px;
    }
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    .insight-card {
        border-left: 4px solid #007bff;
        background-color: #f8f9fa;
    }
    .recommendation-card {
        border-left: 4px solid #28a745;
        background-color: #f8f9fa;
    }
    .demo-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .real-analysis {
        animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .bg-purple {
        background-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <!-- Connection Status -->
    <div class="connection-status {% if google_fit_connected %}connected{% else %}disconnected{% endif %}">
        <strong>Google Fit Status:</strong> 
        {% if google_fit_connected %}
            ‚úÖ Connected - You can now sync your health data
        {% else %}
            ‚ùå Not Connected - Connect to view your real health data
        {% endif %}
    </div>

    <!-- Data Collection Guide (Shows when no real data) -->
    {% if not has_sufficient_data and google_fit_connected %}
    <div class="data-collection-guide">
        <div class="guide-header">
            <h4>üîç Let's Collect Your Health Data</h4>
            <p>We need more health data to provide personalized stress analysis</p>
        </div>
        
        <div class="data-requirements">
            <div class="requirement-card">
                <span class="req-icon">‚ù§Ô∏è</span>
                <h5>Heart Rate Data</h5>
                <p class="status-badge {{ heart_rate_status }}">{{ heart_rate_status|title }}</p>
                {% if heart_rate_status == 'missing' %}
                <button onclick="fixHeartRatePermissions()" class="btn-fix">Fix Permissions</button>
                {% endif %}
            </div>
            
            <div class="requirement-card">
                <span class="req-icon">üò¥</span>
                <h5>Sleep Data</h5>
                <p class="status-badge {{ sleep_status }}">{{ sleep_status|title }}</p>
                {% if sleep_status == 'missing' %}
                <p class="help-text">Ensure your sleep is tracked in Google Fit</p>
                {% endif %}
            </div>
            
            <div class="requirement-card">
                <span class="req-icon">üë£</span>
                <h5>Activity Data</h5>
                <p class="status-badge {{ activity_status }}">{{ activity_status|title }}</p>
                {% if activity_status == 'partial' %}
                <p class="help-text">{{ steps_count }} steps recorded - keep moving!</p>
                {% endif %}
            </div>
        </div>
        
        <div class="action-section">
            <h5>Next Steps:</h5>
            <ul class="action-list">
                <li>‚úÖ Wear your fitness tracker for 24 hours</li>
                <li>‚úÖ Ensure Google Fit has permission to access health data</li>
                <li>‚úÖ Sync your wearable device with Google Fit</li>
                <li>‚úÖ Check back tomorrow for your analysis</li>
            </ul>
            
            <button onclick="refreshData()" class="btn-refresh">
                üîÑ Check for New Data
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Demo Data Warning -->
    {% if show_demo_warning %}
    <div class="demo-warning">
        <h5>‚ö†Ô∏è Demo Mode Active</h5>
        <p>Currently showing sample data for demonstration. Only <strong>{{ real_data_days }} out of {{ total_days }}</strong> days contain your real health data.</p>
        <p class="mb-0"><small>Connect Google Fit and sync your data for personalized analysis.</small></p>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="row">
        <div class="col-md-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Header with Actions -->
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Stress Analysis Dashboard</h1>
                <div>
                    {% if not google_fit_connected %}
                        <a href="{% url 'stress_analysis:connect_google_fit' %}" class="btn btn-success">
                            <i class="fas fa-link"></i> Connect Google Fit
                        </a>
                    {% else %}
                        <button class="btn btn-primary me-2" onclick="syncData()" id="syncButton">
                            <i class="fas fa-sync"></i> Sync Data
                        </button>
                        <a href="{% url 'stress_analysis:disconnect_google_fit' %}" class="btn btn-outline-danger">
                            <i class="fas fa-unlink"></i> Disconnect
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Data Sources Information -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-database"></i> Data Sources & Status</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Overall Status:</strong> 
                            <span id="overallStatus" class="badge bg-warning">Loading...</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Sync:</strong> 
                            <span id="lastSync">Never</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Analysis Period:</strong> 
                            <span id="analysisPeriod">Last 7 days</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Data Points:</strong> 
                            <span id="dataPoints">0</span>
                        </div>
                    </div>
                    <div class="row mt-2" id="dataSourcesInfo">
                        <div class="col-md-12">
                            <p class="text-muted mb-0">Analyzing your health data sources...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards (Only show when we have real data) -->
    {% if has_sufficient_data %}
    <div class="row mb-4" id="statisticsCards">
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-primary" id="avgStress">--</div>
                <div class="stat-label">Average Stress Level</div>
                <small class="text-muted" id="stressSource"></small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-success" id="avgHeartRate">--</div>
                <div class="stat-label">Avg Heart Rate (BPM)</div>
                <small class="text-muted" id="hrSource"></small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-info" id="avgSleep">--</div>
                <div class="stat-label">Avg Sleep Duration</div>
                <small class="text-muted" id="sleepSource"></small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card bg-light">
                <div class="stat-value text-warning" id="avgSteps">--</div>
                <div class="stat-label">Average Steps</div>
                <small class="text-muted" id="stepsSource"></small>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ANALYSIS SECTION - Only show when we have sufficient real data -->
    {% if has_sufficient_data %}
    <div class="real-analysis">
        <!-- Main Stress Chart -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-heartbeat"></i> Stress Level Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="stressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Metrics Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-heart"></i> Heart Rate Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="heartRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-bed"></i> Sleep Pattern Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="sleepChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Health Metrics Row 2 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-walking"></i> Activity Analysis (Steps)</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="stepsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-fire"></i> Calories Burned</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="caloriesChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Correlation Analysis -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Correlation Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stress Pattern Analysis -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Stress Pattern Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <canvas id="patternChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div id="patternInsights">
                                    <h6><i class="fas fa-lightbulb"></i> Pattern Insights:</h6>
                                    <div id="insightsContent" class="mt-3">
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin"></i> Analyzing your stress patterns...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Weekly Trends -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-purple text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Weekly Trends Comparison</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recommendations Section -->
        <div class="row mb-4" id="recommendationsSection">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list"></i> Personalized Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendationsContent">
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin"></i> Generating recommendations based on your data...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="card mt-4">
        <div class="card-header">
            <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {% if not google_fit_connected %}
                    <a href="{% url 'stress_analysis:connect_google_fit' %}" class="btn btn-success btn-block mb-2">
                        <i class="fas fa-link"></i> Connect Google Fit
                    </a>
                    {% else %}
                    <button class="btn btn-primary btn-block mb-2" onclick="syncData()">
                        <i class="fas fa-sync"></i> Sync Data Now
                    </button>
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <button class="btn btn-info btn-block mb-2" onclick="loadData()">
                        <i class="fas fa-redo"></i> Refresh Analysis
                    </button>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-warning btn-block mb-2" onclick="generateReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
                <div class="col-md-3">
                    <a href="/" class="btn btn-outline-secondary btn-block mb-2">
                        <i class="fas fa-arrow-left"></i> Back to Main App
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<script>
    // Chart instances
    let stressChart = null;
    let heartRateChart = null;
    let sleepChart = null;
    let stepsChart = null;
    let caloriesChart = null;
    let correlationChart = null;
    let patternChart = null;
    let trendsChart = null;

    // Initialize the dashboard
    function initDashboard() {
        loadData();
        updateConnectionStatus();
    }

    function loadData() {
        showLoadingState();
        
        fetch('/stress-analysis/api/insights/')
            .then(response => response.json())
            .then(data => {
                if (!data.error) {
                    // Only render charts if we have sufficient real data
                    if (data.has_sufficient_data) {
                        renderAllCharts(data);
                        updateStatistics(data);
                        generateInsights(data);
                        generateRecommendations(data);
                    }
                    updateDataSources(data.processed_data || data.stress_data || []);
                    updateDataStatus(data);
                    hideLoadingState();
                } else {
                    showError('Failed to load data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error loading data:', error);
                showError('Error loading data: ' + error);
                hideLoadingState();
            });
    }

    function showLoadingState() {
        document.getElementById('overallStatus').textContent = 'Loading...';
        document.getElementById('overallStatus').className = 'badge bg-secondary';
    }

    function hideLoadingState() {
        // This will be updated by updateDataStatus
    }

    function showError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.connection-status'));
    }

    function updateConnectionStatus() {
        const statusElement = document.getElementById('overallStatus');
        const isConnected = "{{ google_fit_connected|yesno:'true,false' }}" === "true";
        
        if (isConnected) {
            statusElement.textContent = 'Connected';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = 'Not Connected';
            statusElement.className = 'badge bg-danger';
        }
    }

    function updateStatistics(data) {
        if (data.statistics) {
            document.getElementById('avgStress').textContent = data.statistics.average_stress;
            document.getElementById('avgHeartRate').textContent = Math.round(data.heart_rates.reduce((a, b) => a + b, 0) / data.heart_rates.length);
            document.getElementById('avgSleep').textContent = (data.sleep_durations.reduce((a, b) => a + b, 0) / data.sleep_durations.length).toFixed(1);
            document.getElementById('avgSteps').textContent = Math.round(data.steps_data.reduce((a, b) => a + b, 0) / data.steps_data.length).toLocaleString();
            
            // Update data sources for statistics
            updateStatSources(data);
        }
    }

    function updateStatSources(data) {
        const hasRealData = data.has_real_data || false;
        const sourceBadge = hasRealData ? '<span class="badge bg-success data-source-badge">Real</span>' : '<span class="badge bg-warning data-source-badge">Demo</span>';
        
        document.getElementById('stressSource').innerHTML = sourceBadge;
        document.getElementById('hrSource').innerHTML = sourceBadge;
        document.getElementById('sleepSource').innerHTML = sourceBadge;
        document.getElementById('stepsSource').innerHTML = sourceBadge;
    }

    function updateDataSources(stress_data) {
        const container = document.getElementById('dataSourcesInfo');
        
        if (!stress_data || stress_data.length === 0) {
            container.innerHTML = '<p class="text-muted mb-0">No data available. Connect Google Fit to start tracking.</p>';
            return;
        }
        
        // Count data sources
        let sources = { google_fit: 0, demo: 0 };
        let metrics = { heart_rate: 0, sleep: 0, steps: 0, calories: 0 };
        
        stress_data.forEach(day => {
            if (day.data_sources) {
                Object.values(day.data_sources).forEach(source => {
                    sources[source] = (sources[source] || 0) + 1;
                });
                Object.entries(day.data_sources).forEach(([metric, source]) => {
                    if (source === 'google_fit') metrics[metric]++;
                });
            }
        });
        
        const totalDays = stress_data.length;
        const realDataDays = sources.google_fit > 0 ? Math.round(sources.google_fit / 4) : 0; // 4 metrics per day
        
        let html = `
            <div class="row">
                <div class="col-md-4">
                    <strong>Data Coverage:</strong><br>
                    <span class="badge ${realDataDays > 0 ? 'bg-success' : 'bg-warning'}">${realDataDays}/${totalDays} days with real data</span>
                </div>
                <div class="col-md-8">
                    <strong>Real Data Metrics:</strong><br>
                    <small>
                        <span class="badge ${metrics.heart_rate > 0 ? 'bg-success' : 'bg-secondary'}">Heart Rate: ${metrics.heart_rate}/${totalDays} days</span>
                        <span class="badge ${metrics.sleep > 0 ? 'bg-success' : 'bg-secondary'}">Sleep: ${metrics.sleep}/${totalDays} days</span>
                        <span class="badge ${metrics.steps > 0 ? 'bg-success' : 'bg-secondary'}">Steps: ${metrics.steps}/${totalDays} days</span>
                        <span class="badge ${metrics.calories > 0 ? 'bg-success' : 'bg-secondary'}">Calories: ${metrics.calories}/${totalDays} days</span>
                    </small>
                </div>
            </div>
        `;
        
        container.innerHTML = html;
    }

    function updateDataStatus(data) {
        const overallStatus = document.getElementById('overallStatus');
        const lastSync = document.getElementById('lastSync');
        const dataPoints = document.getElementById('dataPoints');
        
        if (data.has_sufficient_data) {
            overallStatus.textContent = 'Real Data';
            overallStatus.className = 'badge bg-success';
        } else if (data.has_real_data) {
            overallStatus.textContent = 'Partial Data';
            overallStatus.className = 'badge bg-warning';
        } else {
            overallStatus.textContent = 'Demo Data';
            overallStatus.className = 'badge bg-secondary';
        }
        
        lastSync.textContent = new Date().toLocaleString();
        
        if (data.statistics) {
            dataPoints.textContent = data.statistics.data_points;
        }
    }

    function renderAllCharts(data) {
        renderStressChart(data);
        renderHeartRateChart(data);
        renderSleepChart(data);
        renderStepsChart(data);
        renderCaloriesChart(data);
        renderCorrelationChart(data);
        renderPatternChart(data);
        renderTrendsChart(data);
    }

    // All chart rendering functions remain the same as your original code
    function renderStressChart(data) {
        const ctx = document.getElementById('stressChart').getContext('2d');
        if (stressChart) stressChart.destroy();

        stressChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Stress Level',
                    data: data.stress_levels,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: 'Daily Stress Level Trend' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Stress: ${context.parsed.y}/100`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Stress Level (0-100)' }
                    },
                    x: {
                        title: { display: true, text: 'Date' }
                    }
                }
            }
        });
    }

    // ... include all other chart rendering functions from your original code
    // (heartRateChart, sleepChart, stepsChart, caloriesChart, correlationChart, patternChart, trendsChart)

    function calculateCorrelation(array1, array2) {
        const n = array1.length;
        const sum1 = array1.reduce((a, b) => a + b, 0);
        const sum2 = array2.reduce((a, b) => a + b, 0);
        const sum1Sq = array1.reduce((a, b) => a + b * b, 0);
        const sum2Sq = array2.reduce((a, b) => a + b * b, 0);
        const pSum = array1.reduce((a, b, i) => a + b * array2[i], 0);
        
        const num = pSum - (sum1 * sum2 / n);
        const den = Math.sqrt((sum1Sq - sum1 * sum1 / n) * (sum2Sq - sum2 * sum2 / n));
        
        return den === 0 ? 0 : Math.round((num / den) * 100) / 100;
    }

    function generateInsights(data) {
        const insightsContent = document.getElementById('insightsContent');
        
        if (!data.has_sufficient_data) {
            insightsContent.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> 
                    Need more data for personalized insights. Continue using your fitness tracker and check back later.
                </div>
            `;
            return;
        }

        const avgStress = data.statistics.average_stress;
        const maxStress = data.statistics.max_stress;
        const minStress = data.statistics.min_stress;
        
        let insights = [];
        
        // Your existing insight generation logic here
        if (avgStress < 25) {
            insights.push('Your stress levels are generally low and healthy. Keep up your current lifestyle habits!');
        } else if (avgStress < 50) {
            insights.push('You have moderate stress levels. Consider incorporating daily relaxation techniques like meditation or deep breathing.');
        } else if (avgStress < 75) {
            insights.push('Your stress levels are high. Regular exercise, proper sleep, and mindfulness can help manage stress effectively.');
        } else {
            insights.push('You have very high stress levels. Consider consulting a healthcare professional and implementing stress management strategies.');
        }
        
        insightsContent.innerHTML = insights.map(insight => 
            `<div class="alert alert-info insight-card mb-2">
                <i class="fas fa-info-circle"></i> ${insight}
            </div>`
        ).join('');
    }

    function generateRecommendations(data) {
        const recommendationsContent = document.getElementById('recommendationsContent');
        
        if (!data.has_sufficient_data) {
            recommendationsContent.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> 
                    Connect Google Fit and sync more health data to receive personalized recommendations.
                </div>
            `;
            return;
        }

        // Your existing recommendation generation logic here
        const recommendations = [
            {
                title: 'Practice Deep Breathing',
                description: '5-10 minutes of deep breathing exercises daily can lower cortisol levels',
                priority: 'high',
                icon: 'fas fa-wind'
            }
            // ... more recommendations
        ];
        
        recommendationsContent.innerHTML = recommendations.map(rec => 
            `<div class="alert ${rec.priority === 'high' ? 'alert-danger' : rec.priority === 'medium' ? 'alert-warning' : 'alert-info'} recommendation-card mb-2">
                <i class="${rec.icon} me-2"></i>
                <strong>${rec.title}</strong><br>
                <small>${rec.description}</small>
            </div>`
        ).join('');
    }

    function syncData() {
        const syncButton = document.getElementById('syncButton');
        const originalText = syncButton.textContent;
        
        syncButton.disabled = true;
        syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
        
        fetch('/stress-analysis/sync-data/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('‚úÖ ' + data.message, 'success');
                setTimeout(() => {
                    window.location.reload(); // Reload to show updated data
                }, 2000);
            } else {
                showAlert('‚ùå Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('‚ùå Sync failed: ' + error, 'danger');
        })
        .finally(() => {
            syncButton.disabled = false;
            syncButton.innerHTML = originalText;
        });
    }

    function refreshData() {
        showAlert('üîÑ Checking for new data...', 'info');
        loadData();
    }

    function fixHeartRatePermissions() {
        showAlert('üîß Redirecting to fix heart rate permissions...', 'info');
        // In a real implementation, this would redirect to re-authenticate with proper scopes
        window.location.href = '/stress-analysis/google-fit-auth/?scopes=heart_rate';
    }

    function generateReport() {
        showAlert('üìä Report generation feature will be implemented soon!', 'info');
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.connection-status'));
        
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
        
        // Auto-refresh every 5 minutes if connected
        const isConnected = "{{ google_fit_connected|yesno:'true,false' }}" === "true";
        if (isConnected) {
            setInterval(loadData, 300000); // 5 minutes
        }
    });
</script>
{% endblock %}