{% extends 'basic.html' %}

{% block body %}
<div class="container-fluid mt-3">
    <h2 class="mb-4">Stress Analysis Dashboard</h2>

    <!-- Overall Status and Actions -->
    <div class="card mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0">Data Status: <span id="overallStatus" class="badge bg-secondary">Loading...</span></h5>
                <small class="text-muted">Last Sync: <span id="lastSync">N/A</span> | Data Points: <span id="dataPoints">N/A</span></small>
            </div>
            <div>
                <button id="syncButton" class="btn btn-primary me-2"><i class="fas fa-sync-alt"></i> Sync Google Fit</button>
                <button id="refreshDataBtn" class="btn btn-info me-2"><i class="fas fa-redo"></i> Refresh Data</button>
                <button id="generateReportBtn" class="btn btn-success"><i class="fas fa-file-alt"></i> Generate Report</button>
            </div>
        </div>
        <div class="card-footer" id="syncStatus"></div>
    </div>

    <!-- Statistics Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="min-height: 120px;">
                    <h5 class="card-title">Avg. Stress Level</h5>
                    <p class="card-text fs-3" id="avgStress">--</p>
                    <small class="text-muted" id="stressSource"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="min-height: 120px;">
                    <h5 class="card-title">Avg. Heart Rate</h5>
                    <p class="card-text fs-3" id="avgHeartRate">--</p>
                    <small class="text-muted" id="hrSource"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="min-height: 120px;">
                    <h5 class="card-title">Avg. Sleep (hrs)</h5>
                    <p class="card-text fs-3" id="avgSleep">--</p>
                    <small class="text-muted" id="sleepSource"></small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body" style="min-height: 120px;">
                    <h5 class="card-title">Avg. Steps</h5>
                    <p class="card-text fs-3" id="avgSteps">--</p>
                    <small class="text-muted" id="stepsSource"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daily Stress Level Trend</h5>
                    <div id="stressChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="stressChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daily Heart Rate Trend</h5>
                    <div id="heartRateChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="heartRateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daily Sleep Duration</h5>
                    <div id="sleepChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="sleepChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daily Step Count</h5>
                    <div id="stepsChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="stepsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 3 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daily Calories Burned</h5>
                    <div id="caloriesChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="caloriesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Stress Correlations</h5>
                    <div id="correlationChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="correlationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 4 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Stress Level Distribution</h5>
                    <div id="patternChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="patternChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Stress vs Activity Trends</h5>
                    <div id="trendsChartMessage" class="chart-message"></div>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Collection Guide -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Data Collection Guide</h5>
        </div>
        <div class="card-body" style="min-height: 150px;">
            <p>To get personalized stress analysis, please ensure your Google Fit account is connected and permissions are granted.</p>
            <ul>
                <li><strong>Connect Google Fit:</strong> If not already connected, click the "Sync Google Fit" button above.</li>
                <li><strong>Grant Permissions:</strong> Ensure all necessary permissions, especially for heart rate data, are granted. If heart rate data is missing, click <a href="#" data-action="fix-heart-rate">here</a> to fix permissions.</li>
            </ul>
            <button id="syncDataBtn" class="btn btn-primary me-2"><i class="fas fa-sync-alt"></i> Sync Data Now</button>
            <button class="btn btn-info" data-action="refresh-data"><i class="fas fa-redo"></i> Refresh Dashboard</button>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
<style>
    .chart-container {
        position: relative;
        width: 100%;
    }
    .chart-message {
        margin-bottom: 10px;
        font-size: 0.875rem;
    }
    .data-source-badge {
        font-size: 0.7rem;
    }
</style>
<script>
    // Chart instances
    let stressChart = null;
    let heartRateChart = null;
    let sleepChart = null;
    let stepsChart = null;
    let caloriesChart = null;
    let correlationChart = null;
    let patternChart = null;
    let trendsChart = null;

    // ========== CORE FUNCTIONS ==========
    
    function initDashboard() {
        console.log('Initializing dashboard...');
        initializeEventListeners();
        loadAllCharts();
        updateConnectionStatus();
    }

    function initializeEventListeners() {
        console.log('Initializing event listeners...');
        
        // Sync data buttons
        const syncButton = document.getElementById('syncButton');
        const syncDataBtn = document.getElementById('syncDataBtn');
        
        if (syncButton) syncButton.addEventListener('click', syncData);
        if (syncDataBtn) syncDataBtn.addEventListener('click', syncData);
        
        // Refresh data button
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        if (refreshDataBtn) refreshDataBtn.addEventListener('click', loadAllCharts);
        
        // Generate report button
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) generateReportBtn.addEventListener('click', generateReport);
        
        // Fix heart rate permissions buttons
        const fixHrButtons = document.querySelectorAll('[data-action="fix-heart-rate"]');
        fixHrButtons.forEach(button => {
            button.addEventListener('click', fixHeartRatePermissions);
        });
        
        // Refresh buttons in data collection guide
        const refreshButtons = document.querySelectorAll('[data-action="refresh-data"]');
        refreshButtons.forEach(button => {
            button.addEventListener('click', loadAllCharts);
        });
    }

    function loadAllCharts() {
        console.log('Loading all charts...');
        showLoadingState();
        
        // Load all charts with demo data immediately
        loadStressChart();
        loadHeartRateChart();
        loadSleepChart();
        loadStepsChart();
        loadCaloriesChart();
        loadCorrelationChart();
        loadPatternChart();
        loadTrendsChart();
        
        // Update statistics with demo data
        updateStatisticsWithDemoData();
        updateDataStatus({has_real_data: false, has_sufficient_data: false});
        hideLoadingState();
    }

    // Individual chart loading functions
    function loadStressChart() {
        showChartMessage('stressChart', 'Loading stress data...');
        
        // Try to get real data first
        fetch('/stress-analysis/api/stress-chart/')
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                renderStressChart(data);
                updateChartStatus('stressChart', data.has_real_data);
                showChartMessage('stressChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data - Connect Google Fit for real analysis');
            })
            .catch(error => {
                console.error('Error loading stress chart:', error);
                const demoData = generateDemoStressData();
                renderStressChart(demoData);
                updateChartStatus('stressChart', false);
                showChartMessage('stressChart', 'Demo data - Connect to Google Fit for personalized analysis');
            });
    }

    function loadHeartRateChart() {
        showChartMessage('heartRateChart', 'Loading heart rate data...');
        
        fetch('/stress-analysis/api/heart-rate-chart/')
            .then(response => response.json())
            .then(data => {
                renderHeartRateChart(data);
                updateChartStatus('heartRateChart', data.has_real_data);
                showChartMessage('heartRateChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading heart rate chart:', error);
                const demoData = generateDemoHeartRateData();
                renderHeartRateChart(demoData);
                updateChartStatus('heartRateChart', false);
                showChartMessage('heartRateChart', 'Demo data');
            });
    }

    function loadSleepChart() {
        showChartMessage('sleepChart', 'Loading sleep data...');
        
        fetch('/stress-analysis/api/sleep-chart/')
            .then(response => response.json())
            .then(data => {
                renderSleepChart(data);
                updateChartStatus('sleepChart', data.has_real_data);
                showChartMessage('sleepChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading sleep chart:', error);
                const demoData = generateDemoSleepData();
                renderSleepChart(demoData);
                updateChartStatus('sleepChart', false);
                showChartMessage('sleepChart', 'Demo data');
            });
    }

    function loadStepsChart() {
        showChartMessage('stepsChart', 'Loading steps data...');
        
        fetch('/stress-analysis/api/steps-chart/')
            .then(response => response.json())
            .then(data => {
                renderStepsChart(data);
                updateChartStatus('stepsChart', data.has_real_data);
                showChartMessage('stepsChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading steps chart:', error);
                const demoData = generateDemoStepsData();
                renderStepsChart(demoData);
                updateChartStatus('stepsChart', false);
                showChartMessage('stepsChart', 'Demo data');
            });
    }

    function loadCaloriesChart() {
        showChartMessage('caloriesChart', 'Loading calories data...');
        
        fetch('/stress-analysis/api/calories-chart/')
            .then(response => response.json())
            .then(data => {
                renderCaloriesChart(data);
                updateChartStatus('caloriesChart', data.has_real_data);
                showChartMessage('caloriesChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading calories chart:', error);
                const demoData = generateDemoCaloriesData();
                renderCaloriesChart(demoData);
                updateChartStatus('caloriesChart', false);
                showChartMessage('caloriesChart', 'Demo data');
            });
    }

    function loadCorrelationChart() {
        showChartMessage('correlationChart', 'Loading correlation data...');
        
        fetch('/stress-analysis/api/correlation-chart/')
            .then(response => response.json())
            .then(data => {
                renderCorrelationChart(data);
                updateChartStatus('correlationChart', data.has_real_data);
                showChartMessage('correlationChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading correlation chart:', error);
                const demoData = generateDemoCorrelationData();
                renderCorrelationChart(demoData);
                updateChartStatus('correlationChart', false);
                showChartMessage('correlationChart', 'Demo data');
            });
    }

    function loadPatternChart() {
        showChartMessage('patternChart', 'Loading pattern data...');
        
        fetch('/stress-analysis/api/pattern-chart/')
            .then(response => response.json())
            .then(data => {
                renderPatternChart(data);
                updateChartStatus('patternChart', data.has_real_data);
                showChartMessage('patternChart', data.has_real_data ? 'Real Google Fit data' : 'Demo data');
            })
            .catch(error => {
                console.error('Error loading pattern chart:', error);
                const demoData = generateDemoPatternData();
                renderPatternChart(demoData);
                updateChartStatus('patternChart', false);
                showChartMessage('patternChart', 'Demo data');
            });
    }

    function loadTrendsChart() {
        showChartMessage('trendsChart', 'Loading trends data...');
        
        // For trends chart, use demo data directly
        const demoData = generateDemoTrendsData();
        renderTrendsChart(demoData);
        updateChartStatus('trendsChart', false);
        showChartMessage('trendsChart', 'Demo data');
    }

    // Demo data generators
    function generateDemoStressData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            stress_levels: [65, 58, 72, 45, 68, 52, 61],
            has_real_data: false
        };
    }

    function generateDemoHeartRateData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            heart_rates: [72, 75, 68, 80, 72, 76, 70],
            has_real_data: false
        };
    }

    function generateDemoSleepData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            sleep_durations: [7.2, 6.5, 8.1, 7.8, 6.2, 7.5, 7.0],
            has_real_data: false
        };
    }

    function generateDemoStepsData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            steps_data: [8452, 7231, 9567, 6123, 8890, 7543, 8120],
            has_real_data: false
        };
    }

    function generateDemoCaloriesData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            calories_data: [320, 285, 380, 245, 355, 300, 325],
            has_real_data: false
        };
    }

    function generateDemoCorrelationData() {
        return {
            correlations: {
                stress_vs_sleep: -0.65,
                stress_vs_activity: -0.72,
                stress_vs_heart_rate: 0.58
            },
            has_real_data: false
        };
    }

    function generateDemoPatternData() {
        return {
            stress_categories: {
                'Low': 1,
                'Moderate': 3,
                'High': 2,
                'Very High': 1
            },
            has_real_data: false
        };
    }

    function generateDemoTrendsData() {
        const timestamps = generateTimestamps();
        return {
            timestamps: timestamps,
            stress_levels: [65, 58, 72, 45, 68, 52, 61],
            steps_data: [8452, 7231, 9567, 6123, 8890, 7543, 8120],
            has_real_data: false
        };
    }

    function generateTimestamps() {
        const timestamps = [];
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            timestamps.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
        }
        return timestamps;
    }

    function showChartMessage(chartId, message) {
        const messageElement = document.getElementById(chartId + 'Message');
        if (messageElement) {
            messageElement.innerHTML = `<small class="text-muted">${message}</small>`;
        }
    }

    function updateChartStatus(chartId, hasRealData) {
        const chartElement = document.getElementById(chartId);
        if (chartElement) {
            let statusBadge = chartElement.parentElement.querySelector('.chart-status');
            if (!statusBadge) {
                statusBadge = document.createElement('div');
                statusBadge.className = 'chart-status badge ' + (hasRealData ? 'bg-success' : 'bg-warning');
                statusBadge.textContent = hasRealData ? 'Real Data' : 'Demo Data';
                chartElement.parentElement.appendChild(statusBadge);
            } else {
                statusBadge.className = 'chart-status badge ' + (hasRealData ? 'bg-success' : 'bg-warning');
                statusBadge.textContent = hasRealData ? 'Real Data' : 'Demo Data';
            }
        }
    }

    function updateStatisticsWithDemoData() {
        const avgStressEl = document.getElementById('avgStress');
        const avgHeartRateEl = document.getElementById('avgHeartRate');
        const avgSleepEl = document.getElementById('avgSleep');
        const avgStepsEl = document.getElementById('avgSteps');
        
        if (avgStressEl) avgStressEl.textContent = '58.7';
        if (avgHeartRateEl) avgHeartRateEl.textContent = '73';
        if (avgSleepEl) avgSleepEl.textContent = '7.2';
        if (avgStepsEl) avgStepsEl.textContent = '7,996';
        
        // Update data sources
        const sourceBadge = '<span class="badge bg-warning data-source-badge">Demo</span>';
        document.getElementById('stressSource').innerHTML = sourceBadge;
        document.getElementById('hrSource').innerHTML = sourceBadge;
        document.getElementById('sleepSource').innerHTML = sourceBadge;
        document.getElementById('stepsSource').innerHTML = sourceBadge;
    }

    function showLoadingState() {
        const overallStatus = document.getElementById('overallStatus');
        if (overallStatus) {
            overallStatus.textContent = 'Loading...';
            overallStatus.className = 'badge bg-secondary';
        }
    }

    function hideLoadingState() {
        const overallStatus = document.getElementById('overallStatus');
        if (overallStatus) {
            overallStatus.textContent = 'Demo Data';
            overallStatus.className = 'badge bg-warning';
        }
    }

    function updateConnectionStatus() {
        const statusElement = document.getElementById('overallStatus');
        const isConnected = "{{ google_fit_connected|yesno:'true,false' }}" === "true";
        
        if (statusElement && isConnected) {
            statusElement.textContent = 'Connected';
            statusElement.className = 'badge bg-success';
        }
    }

    function updateDataStatus(data) {
        const lastSync = document.getElementById('lastSync');
        const dataPoints = document.getElementById('dataPoints');
        
        if (lastSync) {
            lastSync.textContent = new Date().toLocaleString();
        }
        
        if (dataPoints) {
            dataPoints.textContent = data.statistics?.data_points || '7';
        }
    }

    // Chart rendering functions with consistent height
    function renderStressChart(data) {
        const ctx = document.getElementById('stressChart');
        if (!ctx) return;
        
        if (stressChart) stressChart.destroy();

        stressChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Stress Level',
                    data: data.stress_levels,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false // Remove title since we have card title
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: { display: true, text: 'Stress Level' }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderHeartRateChart(data) {
        const ctx = document.getElementById('heartRateChart');
        if (!ctx) return;
        
        if (heartRateChart) heartRateChart.destroy();

        heartRateChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Heart Rate (BPM)',
                    data: data.heart_rates,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 50,
                        max: 120,
                        title: { display: true, text: 'Heart Rate' }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderSleepChart(data) {
        const ctx = document.getElementById('sleepChart');
        if (!ctx) return;
        
        if (sleepChart) sleepChart.destroy();

        sleepChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Sleep Duration (hours)',
                    data: data.sleep_durations,
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: { display: true, text: 'Hours' }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderStepsChart(data) {
        const ctx = document.getElementById('stepsChart');
        if (!ctx) return;
        
        if (stepsChart) stepsChart.destroy();

        stepsChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Steps',
                    data: data.steps_data,
                    backgroundColor: 'rgba(153, 102, 255, 0.7)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Steps' }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderCaloriesChart(data) {
        const ctx = document.getElementById('caloriesChart');
        if (!ctx) return;
        
        if (caloriesChart) caloriesChart.destroy();

        caloriesChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [{
                    label: 'Calories Burned',
                    data: data.calories_data,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                    tension: 0.4,
                    fill: true,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Calories' }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    function renderCorrelationChart(data) {
        const ctx = document.getElementById('correlationChart');
        if (!ctx) return;
        
        if (correlationChart) correlationChart.destroy();

        correlationChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Stress vs Sleep', 'Stress vs Activity', 'Stress vs Heart Rate'],
                datasets: [{
                    label: 'Correlation Coefficient',
                    data: [
                        data.correlations.stress_vs_sleep,
                        data.correlations.stress_vs_activity,
                        data.correlations.stress_vs_heart_rate
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 99, 132, 0.7)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                let interpretation = '';
                                if (Math.abs(value) >= 0.7) interpretation = ' (Strong)';
                                else if (Math.abs(value) >= 0.5) interpretation = ' (Moderate)';
                                else if (Math.abs(value) >= 0.3) interpretation = ' (Weak)';
                                else interpretation = ' (Very Weak)';
                                return `Correlation: ${value.toFixed(2)}${interpretation}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: -1,
                        max: 1,
                        title: { display: true, text: 'Correlation' }
                    }
                }
            }
        });
    }

    function renderPatternChart(data) {
        const ctx = document.getElementById('patternChart');
        if (!ctx) return;
        
        if (patternChart) patternChart.destroy();

        patternChart = new Chart(ctx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: Object.keys(data.stress_categories),
                datasets: [{
                    data: Object.values(data.stress_categories),
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.7)',  // Low - Green
                        'rgba(255, 205, 86, 0.7)',  // Moderate - Yellow
                        'rgba(255, 159, 64, 0.7)',  // High - Orange
                        'rgba(255, 99, 132, 0.7)'   // Very High - Red
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 205, 86, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 132, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }

    function renderTrendsChart(data) {
        const ctx = document.getElementById('trendsChart');
        if (!ctx) return;
        
        if (trendsChart) trendsChart.destroy();

        trendsChart = new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: data.timestamps,
                datasets: [
                    {
                        label: 'Stress Level',
                        data: data.stress_levels,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Steps (scaled)',
                        data: data.steps_data.map(steps => steps / 100),
                        borderColor: 'rgb(153, 102, 255)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: { 
                        display: false
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Stress Level' },
                        min: 0,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Steps (รท 100)' },
                        min: 0,
                        max: 100,
                        grid: {
                            drawOnChartArea: false,
                        },
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
    }

    // ========== DATA MANAGEMENT FUNCTIONS ==========

    function syncData() {
        console.log('Syncing data with Google Fit...');
        
        const syncButton = document.getElementById('syncButton');
        const originalText = syncButton.innerHTML;
        
        // Show loading state
        syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
        syncButton.disabled = true;
        
        // Show sync status
        const syncStatus = document.getElementById('syncStatus');
        if (syncStatus) {
            syncStatus.innerHTML = '<div class="alert alert-info">Syncing with Google Fit...</div>';
        }

        // Simulate API call to sync data
        fetch('/stress-analysis/api/sync-google-fit/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Data synced successfully!', 'success');
                if (syncStatus) {
                    syncStatus.innerHTML = '<div class="alert alert-success">Data synced successfully!</div>';
                }
                // Reload charts with new data
                setTimeout(() => {
                    loadAllCharts();
                    updateConnectionStatus();
                }, 1000);
            } else {
                throw new Error(data.error || 'Sync failed');
            }
        })
        .catch(error => {
            console.error('Sync error:', error);
            showNotification('Sync failed: ' + error.message, 'error');
            if (syncStatus) {
                syncStatus.innerHTML = '<div class="alert alert-danger">Sync failed: ' + error.message + '</div>';
            }
        })
        .finally(() => {
            // Restore button state
            setTimeout(() => {
                syncButton.innerHTML = originalText;
                syncButton.disabled = false;
            }, 2000);
        });
    }

    function fixHeartRatePermissions() {
        console.log('Fixing heart rate permissions...');
        
        showNotification('Requesting heart rate permissions...', 'info');
        
        // This would typically redirect to Google Fit OAuth with additional scopes
        fetch('/stress-analysis/api/fix-heart-rate-permissions/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.auth_url) {
                // Redirect to Google OAuth for additional permissions
                window.location.href = data.auth_url;
            } else if (data.success) {
                showNotification('Heart rate permissions updated!', 'success');
                loadAllCharts();
            } else {
                throw new Error(data.error || 'Permission update failed');
            }
        })
        .catch(error => {
            console.error('Permission error:', error);
            showNotification('Failed to update permissions: ' + error.message, 'error');
        });
    }

    function generateReport() {
        console.log('Generating stress analysis report...');
        
        const generateReportBtn = document.getElementById('generateReportBtn');
        const originalText = generateReportBtn.innerHTML;
        
        // Show loading state
        generateReportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
        generateReportBtn.disabled = true;
        
        showNotification('Generating your stress analysis report...', 'info');
        
        // Generate report via API
        fetch('/stress-analysis/api/generate-report/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.report_url) {
                showNotification('Report generated successfully!', 'success');
                // Open report in new tab
                window.open(data.report_url, '_blank');
            } else {
                throw new Error(data.error || 'Report generation failed');
            }
        })
        .catch(error => {
            console.error('Report generation error:', error);
            showNotification('Failed to generate report: ' + error.message, 'error');
        })
        .finally(() => {
            // Restore button state
            setTimeout(() => {
                generateReportBtn.innerHTML = originalText;
                generateReportBtn.disabled = false;
            }, 2000);
        });
    }

    // ========== UTILITY FUNCTIONS ==========

    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }

    function showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.alert-dismissible');
        existingNotifications.forEach(notification => notification.remove());
        
        const alertClass = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'warning': 'alert-warning',
            'info': 'alert-info'
        }[type] || 'alert-info';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        const container = document.querySelector('.container-fluid');
        if (container) {
            container.insertBefore(notification, container.firstChild);
        }
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // ========== INITIALIZATION ==========

    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        initDashboard();
    });

    // Export functions for global access (if needed)
    window.StressDashboard = {
        initDashboard,
        syncData,
        loadAllCharts,
        generateReport,
        fixHeartRatePermissions
    };

</script>
{% endblock %}